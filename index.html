<script>
document.addEventListener("DOMContentLoaded",()=>{
let token="",currentRepo="",editingFile="",deleteConfirm=false;

const output=document.getElementById("output");
const repoSelect=document.getElementById("repoSelect");
const fileNameInput=document.getElementById("fileNameInput");
const fileContentInput=document.getElementById("fileContentInput");
const renamePopup=document.getElementById("renamePopup");
const newNameInput=document.getElementById("newNameInput");

// ===== LOG =====
function log(msg,type="info"){
  const p=document.createElement("p");
  p.textContent=msg;
  p.style.color=(type==="success")?"#0f0":(type==="error")?"#f33":"#0af";
  output.appendChild(p); output.scrollTop=output.scrollHeight;
}

// ===== API =====
async function apiRequest(url,method="GET",body=null){
  const headers={Authorization:`token ${token}`,Accept:"application/vnd.github.v3+json"};
  if(body) headers["Content-Type"]="application/json";
  const res=await fetch(url,{method,headers,body:body?JSON.stringify(body):null});

  if(res.status===204) return {}; // no content
  try{
    return await res.json();
  }catch{
    return {};
  }
}

// ===== TOKEN =====
document.getElementById("saveTokenBtn").addEventListener("click",()=>{
  token=document.getElementById("tokenInput").value.trim();
  if(token){log("âœ… Token disimpan!","success");loadRepos();}
  else log("âš ï¸ Masukkan token!","error");
});

// ===== LOAD REPOS =====
async function loadRepos(){
  try{
    log("ğŸ”„ Memuat daftar repository...","info");
    const repos=await apiRequest("https://api.github.com/user/repos");
    console.log("Repos response:",repos); // Debug
    repoSelect.innerHTML='<option value="">-- Pilih Repo --</option>';
    repos.forEach(r=>{
      const opt=document.createElement("option");
      opt.value=r.full_name;
      opt.textContent=r.full_name;
      repoSelect.appendChild(opt);
    });
    log("âœ… Repo berhasil dimuat.","success");
  }catch(e){log("âŒ Gagal load repo: "+e.message,"error");}
}

// ===== LOAD REPO CONTENT =====
document.getElementById("loadRepoBtn").addEventListener("click",async()=>{
  currentRepo=repoSelect.value;
  if(!currentRepo)return log("âš ï¸ Pilih repo dulu!","error");
  try{
    log(`ğŸ“‚ Memuat isi repo: ${currentRepo} ...`,"info");
    const files=await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/`);
    renderRepoContent(files);
  }catch(e){log("âŒ Error load repo: "+e.message,"error");}
});

function renderRepoContent(files){
  const repoDiv=document.getElementById("fileList");
  repoDiv.innerHTML="<ul>"+files.map(f=>`<li onclick="fileNameInput.value='${f.name}'">${f.type==='dir'?'ğŸ“':'ğŸ“„'} ${f.name}</li>`).join("")+"</ul>";
}

// ===== CRUD + Upload + Folder + Rename + Delete Repo =====
async function createFile(){if(!currentRepo)return log("âš ï¸ Pilih repo dulu!","error");const name=fileNameInput.value.trim();const content=fileContentInput.value||"# File baru\n";if(!name)return log("âš ï¸ Nama file wajib!","error");try{const encoded=btoa(unescape(encodeURIComponent(content)));await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${name}`,"PUT",{message:`Buat file ${name}`,content:encoded});log(`âœ… File ${name} berhasil dibuat.`,"success");fileContentInput.value="";document.getElementById("loadRepoBtn").click();}catch(e){log("âŒ Error buat file: "+e.message,"error");}}
async function editFile(){if(!currentRepo)return log("âš ï¸ Pilih repo dulu!","error");const name=fileNameInput.value.trim();if(!name)return log("âš ï¸ Nama file wajib!","error");if(editingFile!==name){try{const fileData=await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${name}`);fileContentInput.value=decodeURIComponent(escape(atob(fileData.content.replace(/\n/g,""))));editingFile=name;log(`âœï¸ File ${name} siap diedit. Tekan Edit File lagi untuk menyimpan.`,"info");}catch(e){log("âŒ Error ambil file: "+e.message,"error");}}else{try{const fileData=await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${name}`);const encoded=btoa(unescape(encodeURIComponent(fileContentInput.value||"# File kosong\n")));await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${name}`,"PUT",{message:`Edit file ${name}`,content:encoded,sha:fileData.sha});log(`âœ… File ${name} berhasil diedit.`,"success");editingFile="";fileContentInput.value="";document.getElementById("loadRepoBtn").click();}catch(e){log("âŒ Error edit file: "+e.message,"error");}}}
async function deleteFile(){if(!currentRepo)return log("âš ï¸ Pilih repo dulu!","error");const name=fileNameInput.value.trim();if(!name)return log("âš ï¸ Nama file wajib!","error");if(!deleteConfirm||editingFile!==name){deleteConfirm=true;editingFile=name;log("âš ï¸ Tekan Hapus File lagi untuk konfirmasi.","info");return;}try{const fileData=await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${name}`);await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${name}`,"DELETE",{message:`Hapus file ${name}`,sha:fileData.sha});log(`âœ… File ${name} berhasil dihapus.`,"success");deleteConfirm=false;editingFile="";fileContentInput.value="";document.getElementById("loadRepoBtn").click();}catch(e){log("âŒ Error hapus file: "+e.message,"error");deleteConfirm=false;editingFile="";}}
async function createFolder(){if(!currentRepo)return log("âš ï¸ Pilih repo dulu!","error");const name=fileNameInput.value.trim();if(!name)return log("âš ï¸ Nama folder wajib!","error");try{const encoded=btoa(unescape(encodeURIComponent("# Folder kosong")));await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${name}/.gitkeep`,"PUT",{message:`Buat folder ${name}`,content:encoded});log(`âœ… Folder ${name} berhasil dibuat.`,"success");document.getElementById("loadRepoBtn").click();}catch(e){log("âŒ Error buat folder: "+e.message,"error");}}
async function uploadFile(){if(!currentRepo)return log("âš ï¸ Pilih repo dulu!","error");const fileInput=document.createElement("input");fileInput.type="file";fileInput.accept="*/*";fileInput.onchange=async(e)=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=async()=>{const content=reader.result.split(",")[1];try{await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${file.name}`,"PUT",{message:`Upload file ${file.name}`,content:content});log(`âœ… File ${file.name} berhasil diupload.`,"success");document.getElementById("loadRepoBtn").click();}catch(err){log("âŒ Error upload file: "+err.message,"error");}};reader.readAsDataURL(file);};fileInput.click();}
async function deleteRepo(){if(!currentRepo) return log("âš ï¸ Pilih repo dulu!","error");if(!deleteConfirm){deleteConfirm=true;log(`âš ï¸ Tekan Hapus Repo lagi untuk konfirmasi.`,"info");return;}try{await apiRequest(`https://api.github.com/repos/${currentRepo}`,"DELETE");log(`âœ… Repo ${currentRepo} berhasil dihapus.`,"success");deleteConfirm=false;currentRepo="";repoSelect.value="";document.getElementById("loadRepoBtn").click();}catch(e){log("âŒ Error hapus repo: "+e.message,"error");deleteConfirm=false;}}
async function renameItem(){if(!currentRepo) return log("âš ï¸ Pilih repo dulu!","error");const oldName=fileNameInput.value.trim();const newName=newNameInput.value.trim();if(!oldName||!newName)return log("âš ï¸ Nama lama dan baru wajib!","error");try{const fileData=await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${oldName}`);const encoded=btoa(unescape(encodeURIComponent(fileContentInput.value||"# Kosong\n")));await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${newName}`,"PUT",{message:`Rename ${oldName} -> ${newName}`,content:encoded,sha:fileData.sha});await apiRequest(`https://api.github.com/repos/${currentRepo}/contents/${oldName}`,"DELETE",{message:`Hapus ${oldName}`,sha:fileData.sha});log(`âœ… ${oldName} berhasil di rename menjadi ${newName}`,"success");renamePopup.style.display="none";fileNameInput.value=newName;document.getElementById("loadRepoBtn").click();}catch(e){log("âŒ Error rename: "+e.message,"error");renamePopup.style.display="none";}}

// ===== ACTION DROPDOWN =====
window.runAction=function(){
  const action=document.getElementById("actionMenu").value;
  switch(action){
    case "create": createFile(); break;
    case "edit": editFile(); break;
    case "delete": deleteFile(); break;
    case "uploadFileBtn": uploadFile(); break;
    case "createFolder": createFolder(); break;
    case "rename": 
      if(!fileNameInput.value.trim()){log("âš ï¸ Pilih file/folder dulu!","error");return;}
      newNameInput.value=fileNameInput.value.trim();
      renamePopup.style.display="flex"; 
      break;
    case "delletRepo": deleteRepo(); break;
    default: alert("âš ï¸ Pilih aksi dulu!");
  }
};

// ===== COPY & FULLSCREEN =====
window.copyCode=function(){fileContentInput.select();document.execCommand("copy");alert("âœ… Isi berhasil disalin!");};
window.toggleFullscreen=function(){document.getElementById("codeBox").classList.toggle("fullscreen");};

// ===== DARK/LIGHT MODE =====
const toggleBtn=document.getElementById("modeToggle");
toggleBtn.addEventListener("click",()=>{
  document.body.classList.toggle("light");
  document.body.classList.toggle("dark");
  toggleBtn.textContent=document.body.classList.contains("dark")?"ğŸŒ Mode":"ğŸŒ™ Mode";
});

// ===== POPUP RENAME =====
document.getElementById("renameConfirmBtn").addEventListener("click",renameItem);
document.getElementById("renameCancelBtn").addEventListener("click",()=>{renamePopup.style.display="none";});

});
</script>